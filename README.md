# Chise Bot
### Discord Channel Secretary
コミュニティーで Discord を使用する際、以下の仕様に困ったことはないでしょうか？
- すべての Public チャンネルが表示されるのは困る
- 「チャンネルの管理」権限が、作成・編集だけでなく「削除」もできるのは権限が強すぎて不安
- メッセージのピンに必要な「メッセージの管理」権限が、メッセージの「削除」もできるのは権限が強すぎて不安
- slack のように、チャンネルのアーカイブ化をしたい

Chise Bot では以下の機能を提供し、これらの問題を解決します。
- **ポータル** 機能  
チャンネルに参加できるボタンが用意された「ポータル」を使用して、Private チャンネルへ参加することができます。  
ポータルを Public チャンネルに設置することで、Slack のように自分の参加したいチャンネルやカテゴリのみ表示することができます。

- チャンネル作成・編集権限ロールの設定
Public なテキストチャンネル・ボイスチャンネル・カテゴリを作成できるコマンドが用意されています。また、作成以外にも、チャンネル名の変更、トピックの変更もコマンドから行えます。  
コマンドを使用できるロールを設定することで、削除以外の機能を使用することができます。

- メッセージのピン 機能
「メッセージのピン 機能」だけができるコマンドを用意しているので、独立して権限設定できます。

- カテゴリーのアーカイブ化のための補助機能
アーカイブ化のための補助機能があるので、「チャンネルリストからは非表示にしてスッキリさせたいけど、いざというときはアクセスしたい」と言う需要に対応できます。

これらのコマンドは Discordの「スラッシュコマンド」で提供されます。  
サーバー設定の連携サービスより、コマンドを使用できるロール・ユーザー・チャンネルを設定することで、きめ細やかな権限管理ができます。  
例えば、「テキストチャンネルの作成は許可するが、カテゴリの作成は許可しない」「特定のチャンネルでのみコマンドを使用許可する」などができます。

Chise Bot は必要最低限の権限で動作します。`message_content` インテントなどを要求しないため、Bot はサーバー内のメッセージやり取りを Discord に制限され一切取得できません。

・図：ポータル機能の様子  
![image](https://github.com/user-attachments/assets/daef4479-270a-4250-a52c-47053d923580)


# コマンドリスト
## ポータル機能関係
ポータル関係のコマンドリストです。必要権限は、スラッシュコマンドを使用するためのデフォルト設定です。サーバー設定から必要権限を変更できます。空欄はデフォルトで @everyone です。
|コマンド名|説明|必要権限|
|-|-|-|
|/create|プライベートチャンネルを作成し、ポータルを設置します|*|
|/create_category|プライベートカテゴリを作成し、ポータルを設置します。|*|
|/create_category_portal|既存のカテゴリをポータルで管理します。対象のカテゴリ内で使用します。|*|
|/jump|チャンネル内に存在するポータルメッセージを一覧表示します。||
|/list|`/jump` と同じです||
|/where|このチャンネル・カテゴリ**へ**参加するためのポータルメッセージを一覧表示します。||
|/leave|チャンネルから抜けます。指定したユーザーを離脱させることもできます。|(他人に使うときは manage_channels)|
|/leave_category|カテゴリから抜けます。指定したユーザーを離脱させることもできます。|(他人に使うときは manage_channels)|
|/regen|このチャンネルにあるポータルを一旦削除し、新しいポータルを作成します。ポータルが散らばってしまったときに便利です。|*|

権限の `*` に関して、discord システム的にコマンドを使用できるデフォルトは @everyone ですが、コマンド処理中に権限チェックを行い、Chise Bot の create_channel ロールに設定されていれば、もしくはチャンネル編集権限があれば使用できます。  

これは、複数のコマンドの権限を一括で設定するのは大変なので、気軽に create_channel 権限を使えるようにするための仕様です。`/set_create_channel_role add @ROLE` コマンドでロールを設定すれば、チャンネル作成や編集するだけの権限が使用できます。  

もし細かい権限管理を行いたい場合は、`/set_create_channel_role add @everyone` をすれば Bot 内の権限チェックはスルーされるようになるので、discord の機能側でロールやチャンネルの制限を行えます。

## チャンネル作成・編集関係
|コマンド名|説明|必要権限|
|-|-|-|
|/create_public_text|パブリックなテキストチャンネルを作成します。|*|
|/create_public_voice|パブリックなボイスチャンネルを作成します。|*|
|/create_public_category|パブリックなカテゴリを作成します。|*|
|/rename|チャンネルの名前を変更します。|*|
|/topic|チャンネルの名前を変更します。|*|

## Sudo 管理系コマンド
|コマンド名|説明|必要権限|
|-|-|-|
|/sudo|一時管理者ロールを付加（or 解除）をします。|config で設定したロールのみ|

## Bot 管理系コマンド
|コマンド名|説明|必要権限|
|-|-|-|
|/set_create_channel_role|チャンネルを作成・編集できるロールを設定します。|manage_guild|
|/show_create_channel_role|チャンネルを作成できるロールを表示します。||
|/list_all_portal_in_server|サーバー内のポータルメッセージを一覧表示します。|manage_guild|
|/archive_category|現在のカテゴリ内のすべてのチャンネルを、アーカイブカテゴリへリネームして移動します。操作時に確認が行われます。|manage_channels|
|/delete_all_channels_in_category|現在のカテゴリ内のチャンネルを削除します。操作時に確認が行われます。実験用コマンドです。|Administrator のみ|

## メッセージの右クリックメニュー
メッセージを右クリックし、「アプリ」の中から選択できるコマンドです。
|コマンド名|説明|必要権限|
|-|-|-|
|このポータルを再生成|指定したポータルを削除・再生成します。|*|
|このポータルの削除|指定したポータルを削除します。|manage_channels|
|ピン留め|メッセージのピン状態をトルグします|manage_messages|

ポータル系コマンドについて、全てのメッセージで表示されますが、ポータルメッセージのみに使用できます。  
ピン留めについて、デフォルトで「メッセージの管理」権限を持つユーザーのみ使用できる設定になっていますが、サーバー設定から @everyone などに変更することで使用ユーザーを広げることができます。

## ボットの右クリックメニュー
ボットを右クリックし、「アプリ」の中から選択できるコマンドです。（仕様上 bot 以外にも表示されます…）
全てのメッセージで表示されますが、ポータルメッセージのみに使用できます
|コマンド名|説明|必要権限|
|-|-|-|
|Sudo Config を開く|`/sudo` コマンドを使用するための設定を開きます。||

### Discord のイベントに連動した動作
- ポータル管理対象のチャンネルの「名前」「トピック」が変更された場合、対応するポータルも自動更新されます。（チャンネルの権限が変更され、メンバーが変更になった場合は現状、表示は反映されません）
- Bot のポータルメッセージや埋め込みメッセージが削除された場合、ポータルが無効になり、処理が行われます。

# やりたい操作からコマンド逆引き
### ポータルを作り、Private チャンネルを作る
`/create [channel_name] [(Topic)]` でチャンネルが作成できます。`/create_category` でポータル管理されたカテゴリーが作れます。

### 既存のテキストチャンネル・カテゴリをポータル管理化したい
`/create` や `/create_category` は、既存のチャンネルを指定された場合、Bot がそのチャンネルに参加していればポータル管理化することができます。  
つまり、ポータルを作成したいチャンネルで `/create [channel_name]` をするとできます。

### チャンネル内にあるポータルのリストを知りたい
`/jump` 、または `/list`

### チャンネル・カテゴリへ参加するためのポータルのリストを知りたい
`/where`

### チャンネル・カテゴリから離脱したい
`/leave` もしくは `/leave_category`。ポータル管理されていないチャンネルでは権限変更をしません。

### ポータルが流れてしまったので再生成したい
`/regen` でチャンネル内の全てのポータルを再生成できます。  
個別のポータルを再生成したい場合は、右クリック→アプリ→「このポータルを再生成」からできます。

### チャンネルを作りたい。
`/create_public_text`, `/create_public_voice`, `/create_public_category`

### チャンネル名を変えたい・トピックを変えたい
`/rename`, `/topic`

## チャンネルのアーカイブ化のための補助機能
`/create_category_portal` もしくは `/archive_category` でできます。

### /create_category_portal 
カテゴリをポータル管理化します。`/create_category_portal [#ポータルを設置するチャンネル] [(カテゴリを Private 化するか)]` というコマンドで、最後の引数を True にすると、パブリックなカテゴリを非表示に変換できます。  
アーカイブ済みカテゴリに入室するためのチャンネル `#archives` にポータルを設置することにすることで、カテゴリーをアーカイブすることができます。

`/create_category` でも似たようなことができそうですが、`/create_category_portal` の場合はカテゴリの Private 化機能があるので便利です。  
カテゴリを Private 化する場合、操作時に確認が行われます。

### /archive_category
ポータル管理化や権限管理は操作しません。  
`/archive_category {アーカイブ先カテゴリ}` の形で操作し、現在のカテゴリ内のチャンネルがアーカイブ先カテゴリに移動します。アーカイブ時にチャンネル名が衝突しないよう、「{チャンネル名}」が「{カテゴリ名}｜{チャンネル名}」にリネームされます。  
操作時のカテゴリが `Summer2024` で、その中に `#proj1` `#proj2` `#proj3` が存在し、`/archive_category archives2024` と実行した場合、`archives2024` カテゴリの中へ`#Summer2024｜proj1` `#Summer2024｜proj2` `#Summer2024｜proj3` とリネームと移動が行われます。  
Private カテゴリにはしないが、アーカイブカテゴリが多くなりすぎるのは困る場合、一つのアーカイブカテゴリに統合できます。

## `/sudo` コマンドについて
使用したユーザーに、一時管理者ロールを一定時間付加します。  
一時管理者ロールを tmp-admin、使用可能ユーザーのロール を manager としたとき、tmp-admin ロールを manager ロールよりも上に配置することで、sudo 時に manager の編集を行うこともできます。  
Bot の仕様として、不定期に tmp-admin のロールメンバーを削除することがあります。なので tmp-admin ロールは、一時的な管理者のみを入れる専用ロールとして使用してください。

discord の古典テクニックとして、manager にロール管理権限を付加し、その下に admin 権限だけを付加した admin ロールを設置することで、普段は admin 権限を使わず、必要なときに manager が自分で admin ロールを付加することで一時的な admin 権限を得るテクニックがありました。しかしこのテクニックは、manager 以外の誰にでも admin ロールを与えることができてしまうため、事故の元でした。`/sudo` コマンドにより、自分自身のロールのみに操作を限定し、また admin 外し忘れを防止することもできます。

## FAQ
#### ・既存のチャンネルを対象に `/create` コマンドが使用できるということは、秘密のチャンネルの名前を知っていれば、権限を持たない人がポータルを作成して入室できるということですか？  
その Private チャンネルに Chise Bot が参加していない場合はポータルを作成することができません。逆に言うと Bot が参加していると可能になります。秘密の情報を扱うチャンネルには Chise Bot を参加させないでください。

# Bot の動作で必要な権限
Chise Bot の招待リンクに必要な権限情報が埋め込まれているため、特にユーザー・導入者で操作は必要ありません。以下の権限を使用します。
- チャンネルの管理
- ロールの管理
- メッセージを送信
- メッセージの管理：メッセージのピン留め機能で使用します。
- 埋め込みリンク ：ポータルの装飾されたメッセージのことを Discord 用語で「埋め込み」と呼びます。
- メッセージ履歴を読む ：ポータルが discord の「他人のメッセージを削除」操作もしくは「埋め込みを削除」操作で消された場合、どのポータルが削除されたのか検出するために使用されます。ポータルを削除する際にアプリコマンドから消せば必要ありません。

### 使用する特権インテント（インテントについては [こちら](https://discord-media.com/news/privileged-intent.html), [discord.py APIリファレンス](https://discordpy.readthedocs.io/ja/latest/api.html#intents)）
- members  
チャンネルを見れるメンバーリストの取得などに使用されます。

この Bot は [Message Content 特権インテント](https://support-dev.discord.com/hc/ja/articles/4404772028055-%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%88%E7%89%B9%E6%A8%A9%E3%82%A4%E3%83%B3%E3%83%86%E3%83%B3%E3%83%88FAQ)などは **使用しません**。これは原理的に、Bot がユーザーの送信したメッセージを取得することができないことを意味します（Bot にメンションをしたメッセージを除く）。
